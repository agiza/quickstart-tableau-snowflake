USE ROLE ACCOUNTADMIN;

GRANT CREATE ROLE on ACCOUNT to SYSADMIN;

GRANT imported privileges on database snowflake to role SYSADMIN;

USE ROLE SYSADMIN;
drop file format if exists  nyc_taxi_data.public.csv;
drop stage if exists nyc_taxi_data.public.tableau_stage;
drop table if exists nyc_taxi_data.public.yellow_trip_data;
drop role if exists ANALYST_RL;

CREATE or REPLACE WAREHOUSE "LOAD_WH" WITH WAREHOUSE_SIZE = 'LARGE' AUTO_SUSPEND = 300 AUTO_RESUME = TRUE COMMENT = '';

CREATE or REPLACE WAREHOUSE "BI_WH" WITH WAREHOUSE_SIZE = 'MEDIUM' AUTO_SUSPEND = 300 AUTO_RESUME = TRUE COMMENT = '';

CREATE or REPLACE DATABASE NYC_TAXI_DATA;

CREATE or REPLACE ROLE ANALYST_RL;

GRANT ALL on WAREHOUSE BI_WH to ROLE ANALYST_RL;

GRANT USAGE on DATABASE NYC_TAXI_DATA to ROLE ANALYST_RL;

GRANT USAGE on schema NYC_TAXI_DATA.PUBLIC to ROLE ANALYST_RL;

--GRANT SELECT on all tables in NYC_TAXI_DATA.PUBLIC to ROLE ANLYST_RL;
GRANT SELECT  
       ON FUTURE TABLES IN SCHEMA  NYC_TAXI_DATA.PUBLIC

  TO ROLE ANALYST_RL;
  
CREATE or REPLACE FILE FORMAT "NYC_TAXI_DATA"."PUBLIC".CSV
TYPE=CSV
COMPRESSION = 'AUTO' FIELD_DELIMITER = ',' 
RECORD_DELIMITER = '\n' 
SKIP_HEADER = 2 
FIELD_OPTIONALLY_ENCLOSED_BY = 'NONE' 
TRIM_SPACE = FALSE 
ERROR_ON_COLUMN_COUNT_MISMATCH = TRUE 
ESCAPE = 'NONE' 
ESCAPE_UNENCLOSED_FIELD = '\134' 
DATE_FORMAT = 'AUTO' 
TIMESTAMP_FORMAT = 'AUTO' 
NULL_IF = ('\\N');


  CREATE or REPLACE STAGE tableau_stage 
  url='s3://tableau-snowflake-quickstart/nyc-taxi-data'
  file_format = CSV;

use database NYC_TAXI_DATA;

CREATE or REPLACE TABLE "NYC_TAXI_DATA"."PUBLIC"."YELLOW_TRIP_DATA" 
("VENDORID" STRING NOT NULL, 
 "TPEP_PICKUP_DATETIME" DATETIME NOT NULL, 
 "TPEP_DROPOFF_DATETIME" DATETIME NOT NULL, 
 "PASSENGER_COUNT" INTEGER, 
 "TRIP_DISTANCE" NUMBER (15, 2),
 "PICKUP_LONGITUDE" NUMBER (15, 2),
 "PICKUP_LATITUDE" NUMBER (15, 2),
 "RATECODEID" INTEGER, 
 "STORE_AND_FWD_FLAG" STRING, 
 "PULOCATIONID" INTEGER,
 "DOLOCATIONID" INTEGER,
 "PAYMENT_TYPE" INTEGER,
 "FARE_AMOUNT" NUMBER (38, 2),
 "EXTRA" NUMBER (15, 1), 
 "MTA_TAX" NUMBER (15, 1),
 "TIP_AMOUNT" NUMBER (15, 2),
 "TOLLS_AMOUNT" NUMBER (15, 2), 
 "IMPROVEMENT_SURCHARGE" NUMBER (15, 1),
 "TOTAL_AMOUNT" NUMBER (15, 2));


use warehouse LOAD_WH;

COPY INTO YELLOW_TRIP_DATA
FROM 
   @TABLEAU_STAGE 
  FILE_FORMAT= (format_name = CSV);
  
USE WAREHOUSE BI_WH;
USE ROLE ANALYST_RL;
USE DATABASE NYC_TAXI_DATA;
USE SCHEMA PUBLIC;
select count(*) from NYC_TAXI_DATA.PUBLIC.YELLOW_TRIP_DATA;
  
ALTER WAREHOUSE  IF EXISTS LOAD_WH SUSPEND;
ALTER WAREHOUSE  IF EXISTS BI_WH SUSPEND;